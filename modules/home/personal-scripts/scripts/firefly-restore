#!/usr/bin/env bash
# Restore dotfiles, keys, and app configs to a FireFly USB system
# Available on all hosts via personal-scripts (in PATH via sinh-x-scripts)
#
# Usage: firefly-restore [command] [options]

set -euo pipefail

PROGRAM="firefly-restore"
PROFILE="sinh-personal_file"
DEFAULT_TARGET="/persist/home/sinh"
SNAPSHOT_HOME="/home/sinh"
HOST_FILTER="Drgnfly"

ESSENTIAL_DIRS=(
  .ssh
  .gnupg
  .config/gh
  .config/git
  .config/sops/age
  .config/rclone
  .config/rustic
  .zen
  .config/zen
  .local/share/fish
  git-repos/sinh-x/personal-nixos
)

check_prerequisites() {
  local errors=0
  if [[ ! -f "$HOME/.config/rclone/rclone.conf" ]] && [[ ! -f "/persist/home/sinh/.config/rclone/rclone.conf" ]]; then
    echo "ERROR: rclone.conf not found"
    echo "  Copy it manually first: ~/.config/rclone/rclone.conf"
    errors=1
  fi
  if ! rustic -P "$PROFILE" cat config &>/dev/null; then
    echo "ERROR: rustic profile '$PROFILE' not accessible"
    echo "  Copy it manually first: ~/.config/rustic/$PROFILE.toml"
    errors=1
  fi
  if [[ $errors -ne 0 ]]; then
    echo ""
    echo "Bootstrap: manually copy rclone.conf and rustic profile before restoring."
    exit 1
  fi
  echo "Prerequisites OK"
}

cmd_check() {
  check_prerequisites
}

cmd_list() {
  echo "Directories restored by 'essential':"
  for d in "${ESSENTIAL_DIRS[@]}"; do
    echo "  $d"
  done
  echo ""
  echo "Directories restored by 'apps':"
  echo "  .config/  (excluding cache, Code, unity3d, nix symlinks)"
  echo "  .local/   (excluding Trash, baloo, Steam, nix symlinks)"
}

# Auto-detect nix store symlinks and build glob excludes
build_nix_excludes() {
  local dir="$1"
  local globs=()
  while IFS= read -r link; do
    local rel="${link#"$dir"/}"
    globs+=(--glob "!$rel")
  done < <(find "$dir" -type l -lname '/nix/store/*' 2>/dev/null)
  echo "${globs[@]}"
}

cmd_restore_dir() {
  local target="$1"
  local dirname="$2"
  echo "Restoring $dirname -> $target/$dirname"

  # Detect nix store symlinks on target to avoid overwriting NixOS-managed files
  local nix_excludes=""
  if [[ -d "$target/$dirname" ]]; then
    nix_excludes=$(build_nix_excludes "$target/$dirname")
    local count
    count=$(echo "$nix_excludes" | grep -o '!' | wc -l)
    if [[ $count -gt 0 ]]; then
      echo "  Skipping $count nix-managed symlinks on target"
    fi
  fi

  rustic -P "$PROFILE" restore "latest:$SNAPSHOT_HOME/$dirname" "$target/$dirname" \
    --glob '!.direnv' \
    --glob '!.pre-commit-config.yaml' \
    $nix_excludes
}

cmd_essential() {
  local target="${1:-$DEFAULT_TARGET}"
  check_prerequisites
  echo ""
  echo "Restoring essential directories to: $target"
  echo ""
  local failed=()
  for d in "${ESSENTIAL_DIRS[@]}"; do
    if ! cmd_restore_dir "$target" "$d"; then
      echo "WARN: Failed to restore $d, continuing..."
      failed+=("$d")
    fi
    echo ""
  done
  if [[ ${#failed[@]} -gt 0 ]]; then
    echo "Failed to restore: ${failed[*]}"
  fi
  echo "Done. Essential directories restored to $target"
}

cmd_single() {
  local target="$DEFAULT_TARGET"
  local dirname="$1"
  if [[ $# -ge 2 ]]; then
    target="$1"
    dirname="$2"
  fi
  check_prerequisites
  cmd_restore_dir "$target" "$dirname"
}

cmd_apps() {
  local target="${1:-$DEFAULT_TARGET}"
  local dry_run=""
  # Check if first arg is --dry-run
  if [[ "${1:-}" == "--dry-run" ]]; then
    dry_run="--dry-run"
    echo "=== DRY RUN MODE ==="
    target="${2:-$DEFAULT_TARGET}"
  fi

  check_prerequisites

  # Get latest Drgnfly snapshot ID
  echo "Finding latest $HOST_FILTER snapshot..."
  local latest
  latest=$(rustic -P "$PROFILE" snapshots --filter-host "$HOST_FILTER" --json 2>/dev/null \
    | jq -r '.[0].snapshots[-1].id')

  if [[ -z "$latest" || "$latest" == "null" ]]; then
    echo "ERROR: No $HOST_FILTER snapshots found in profile $PROFILE"
    exit 1
  fi

  echo "Restoring from snapshot: $latest ($HOST_FILTER)"
  echo "Target: $target"
  echo ""

  # Restore .config (skip nix-managed, caches, and heavy app dirs)
  echo "=== Detecting nix symlinks in .config ==="
  local nix_excludes_config
  nix_excludes_config=$(build_nix_excludes "$target/.config")
  echo "Found $(echo "$nix_excludes_config" | grep -o '!' | wc -l) nix symlinks to skip"

  echo "=== Restoring .config ==="
  rustic -P "$PROFILE" $dry_run restore "$latest:/home/sinh/.config" "$target/.config" \
    --no-ownership \
    --glob '!cache' \
    --glob '!Code' \
    --glob '!unity3d' \
    --glob '!google-chrome/Default/Service Worker' \
    --glob '!BraveSoftware/*/Service Worker' \
    $nix_excludes_config

  echo ""

  # Restore .local/share (app state: Signal, Telegram, Bitwarden, etc.)
  echo "=== Detecting nix symlinks in .local ==="
  local nix_excludes_local
  nix_excludes_local=$(build_nix_excludes "$target/.local")
  echo "Found $(echo "$nix_excludes_local" | grep -o '!' | wc -l) nix symlinks to skip"

  echo "=== Restoring .local ==="
  rustic -P "$PROFILE" $dry_run restore "$latest:/home/sinh/.local" "$target/.local" \
    --no-ownership \
    --glob '!share/Trash' \
    --glob '!share/baloo' \
    --glob '!share/Steam/**' \
    --glob '!lib' \
    $nix_excludes_local

  echo ""
  echo "Done. You may need to restart apps to pick up restored data."
}

cmd_usage() {
  cat <<_EOF
$PROGRAM — Restore dotfiles, keys, and app configs to a FireFly USB system

FireFly uses impermanence (btrfs root rollback on every boot), so only
/persist and /nix survive reboots. This tool restores personal files from
a rustic (restic-compatible) backup into the persistent volume.

BOOTSTRAP (first boot on a new machine):
  1. Mount the persistent volume if not already mounted
  2. Manually copy these two files (they can't be restored without themselves):
       ~/.config/rclone/rclone.conf              (cloud storage credentials)
       ~/.config/rustic/$PROFILE.toml   (backup profile)
  3. Run: $PROGRAM essential
  4. Optionally: $PROGRAM apps    (restore app configs from $HOST_FILTER)

COMMANDS:
    $PROGRAM                              Show this manual
    $PROGRAM check                        Verify prerequisites (rclone, rustic)
    $PROGRAM list                         List directories restored by each command
    $PROGRAM essential [target]           Restore bootstrap dirs (keys, git, dotfiles)
    $PROGRAM apps [--dry-run] [target]    Restore app configs (.config, .local) from $HOST_FILTER
    $PROGRAM <dirname> [target]           Restore a single directory

ESSENTIAL DIRECTORIES (restored by 'essential'):
$(printf '    %s\n' "${ESSENTIAL_DIRS[@]}")

APP RESTORE (restored by 'apps'):
    .config/  — app configurations (excludes cache, Code, nix symlinks)
    .local/   — app state and data (excludes Trash, baloo, Steam, nix symlinks)
    Source: latest $HOST_FILTER snapshot from rustic profile '$PROFILE'

EXAMPLES:
    $PROGRAM essential                          # Normal restore after boot
    $PROGRAM essential /mnt/persist/home/sinh   # During initial install
    $PROGRAM apps                               # Restore app configs from $HOST_FILTER
    $PROGRAM apps --dry-run                     # Preview app restore
    $PROGRAM .ssh                               # Restore just SSH keys
    $PROGRAM Documents /mnt/persist/home/sinh   # Single dir to custom target

RUSTIC PROFILE: $PROFILE
SNAPSHOT BASE:  $SNAPSHOT_HOME
DEFAULT TARGET: $DEFAULT_TARGET
_EOF
}

COMMAND="${1:-help}"
case "$COMMAND" in
  check|c)       cmd_check ;;
  list|ls|l)     cmd_list ;;
  essential|e)   shift; cmd_essential "$@" ;;
  apps|a)        shift; cmd_apps "$@" ;;
  help|--help|-h) cmd_usage ;;
  *)             cmd_single "$@" ;;
esac
