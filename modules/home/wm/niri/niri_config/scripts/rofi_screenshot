#!/usr/bin/env bash

## Screenshot menu for Niri

# Get Colors
DIR="$HOME/.config/niri"
background="$(cat "$DIR"/rofi/shared/colors.rasi | grep 'background:' | cut -d':' -f2 | tr -d ' '\;)"
accent="$(cat "$DIR"/rofi/shared/colors.rasi | grep 'selected:' | cut -d':' -f2 | tr -d ' '\;)"

# Import Current Theme
RASI="$DIR/rofi/screenshot.rasi"

# Theme Elements
prompt='Screenshot'
mesg="Directory :: $HOME/Pictures/Screenshots"

# Options
layout=$(cat "$RASI" | grep 'USE_ICON' | cut -d'=' -f2)
if [[ "$layout" == 'NO' ]]; then
  option_1="󰍹 Capture Desktop"
  option_2="󰩭 Capture Area"
  option_3="󰖯 Capture Window"
  option_4="󰔝 Capture in 5s"
  option_5="󰔜 Capture in 10s"
else
  option_1="󰍹"
  option_2="󰩭"
  option_3="󰖯"
  option_4="󰔝"
  option_5="󰔜"
fi

# Rofi CMD
rofi_cmd() {
  rofi -dmenu \
    -p "$prompt" \
    -mesg "$mesg" \
    -markup-rows \
    -theme "$RASI"
}

# Pass variables to rofi dmenu
run_rofi() {
  echo -e "$option_1\n$option_2\n$option_3\n$option_4\n$option_5" | rofi_cmd
}

# Screenshot
time=$(date +%Y-%m-%d-%H-%M-%S)
dir="$HOME/Pictures/Screenshots"
file="Screenshot_${time}.png"

# Directory
if [[ ! -d "$dir" ]]; then
  mkdir -p "$dir"
fi

# notify and view screenshot
iDIR="$HOME/.config/niri/mako/icons"
notify_cmd_shot="notify-send -h string:x-canonical-private-synchronous:sys-notify-shot -u low -i ${iDIR}/picture.png"

notify_view() {
  $notify_cmd_shot "Copied to clipboard."
  viewnior "$dir/$file"
  if [[ -e "$dir/$file" ]]; then
    $notify_cmd_shot "Screenshot Saved" "$dir/$file"
  else
    $notify_cmd_shot "Screenshot Deleted."
  fi
}

# countdown
countdown() {
  for sec in $(seq "$1" -1 1); do
    notify-send -h string:x-canonical-private-synchronous:sys-notify-count -t 1000 -i "$iDIR"/timer.png "Taking shot in : $sec"
    sleep 1
  done
}

# take shots
shotnow() {
  cd "$dir" && sleep 0.5 && grim - | tee "$file" | wl-copy
  notify_view
}

shot5() {
  countdown '5'
  sleep 1 && cd "$dir" && grim - | tee "$file" | wl-copy
  notify_view
}

shot10() {
  countdown '10'
  sleep 1 && cd "$dir" && grim - | tee "$file" | wl-copy
  notify_view
}

shotwin() {
  # Get focused window geometry from niri
  local win_info=$(niri msg focused-window 2>/dev/null)
  if [[ -z "$win_info" ]]; then
    $notify_cmd_shot "No focused window found"
    return 1
  fi

  # Parse window position and size from niri output
  local x=$(echo "$win_info" | grep -oP 'Tile pos in workspace view: \K\d+' | head -1)
  local y=$(echo "$win_info" | grep -oP 'Tile pos in workspace view: \d+, \K\d+')
  local w=$(echo "$win_info" | grep -oP 'Window size: \K\d+')
  local h=$(echo "$win_info" | grep -oP 'Window size: \d+ x \K\d+')

  if [[ -n "$x" && -n "$y" && -n "$w" && -n "$h" ]]; then
    cd "$dir" && sleep 0.3 && grim -g "${x},${y} ${w}x${h}" - | tee "$file" | wl-copy
    notify_view
  else
    $notify_cmd_shot "Could not get window geometry"
    return 1
  fi
}

shotarea() {
  cd "$dir" && grim -g "$(slurp -b "${background:1}CC" -c "${accent:1}ff" -s "${accent:1}0D" -w 2)" - | tee "$file" | wl-copy
  notify_view
}

# Execute Command
run_cmd() {
  case "$1" in
    --opt1) shotnow ;;
    --opt2) shotarea ;;
    --opt3) shotwin ;;
    --opt4) shot5 ;;
    --opt5) shot10 ;;
  esac
}

# Actions
chosen="$(run_rofi)"

# Exit if no selection (ESC pressed)
[[ -z "$chosen" ]] && exit 0

case ${chosen} in
  "$option_1") run_cmd --opt1 ;;
  "$option_2") run_cmd --opt2 ;;
  "$option_3") run_cmd --opt3 ;;
  "$option_4") run_cmd --opt4 ;;
  "$option_5") run_cmd --opt5 ;;
esac
