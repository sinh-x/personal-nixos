# Dynamic Hyprland Workspace Configuration - Implementation Tasks

## Task Overview

This document breaks down the implementation of dynamic Hyprland workspace configuration into actionable coding tasks. Each task is designed to be completed incrementally, with clear deliverables and requirements traceability.

**Total Tasks**: 13 tasks organized into 5 phases

**Requirements Reference**: `requirements.md`

**Design Reference**: `design.md`

## Implementation Tasks

### Phase 1: Module Options Setup

- [x] **1.1** Define Nix module options structure
  - **Description**: Extend the existing `modules/home/wm/hyprland/default.nix` to include the new configuration options for monitors, workspaces, and keybindings as specified in design.md.
  - **Deliverables**:
    - Modify `modules/home/wm/hyprland/default.nix` with new options
  - **Requirements**: Nix Configuration Requirements (Section 4)
  - **Dependencies**: None
  - **Details**:
    ```nix
    options.${namespace}.wm.hyprland = {
      enable = mkEnableOption "...";
      monitors.primary = mkOption { ... };
      monitors.externalPosition = mkOption { ... };
      monitors.refreshRate = mkOption { ... };
      workspaces.perMonitor = mkOption { ... };
      workspaces.distribution = mkOption { ... };
      keybindings.generateFKeys = mkOption { ... };
    };
    ```

- [x] **1.2** Add required library imports
  - **Description**: Ensure the module has access to required Nix lib functions (`mkOption`, `types`, etc.) and add any missing imports.
  - **Deliverables**:
    - Update imports in `modules/home/wm/hyprland/default.nix`
  - **Requirements**: Technical Architecture (Section 7)
  - **Dependencies**: 1.1

### Phase 2: Script Generation

- [x] **2.1** Create `generate_workspace_config` script template
  - **Description**: Write the bash script as a Nix string with interpolated values for primary monitor, external position, refresh rate, workspaces per monitor, distribution strategy, and F-key generation flag.
  - **Deliverables**:
    - Add script generation in `modules/home/wm/hyprland/default.nix`
  - **Requirements**: Monitor Detection Requirements, Workspace Distribution Requirements (Section 4)
  - **Dependencies**: 1.1, 1.2
  - **Details**:
    - Script should handle auto-detection when `monitors.primary = null`
    - Implement both `split` and `primary-all` distribution strategies
    - Generate workspaces.conf with correct monitor assignments

- [x] **2.2** Implement workspace distribution logic
  - **Description**: Implement the two distribution strategies (`split` and `primary-all`) in the generated script with proper workspace-to-monitor assignments.
  - **Deliverables**:
    - Distribution logic in generated script
  - **Requirements**: Workspace Distribution Requirements (Section 4)
  - **Dependencies**: 2.1
  - **Details**:
    - `split`: Primary gets 1-5, 11-15; External gets 6-10, 16-20
    - `primary-all`: Primary gets 1-10; External gets 11-20
    - Single monitor fallback: All workspaces on primary

- [x] **2.3** Implement keybinding generation
  - **Description**: Add keybinding generation to the script following the principle: 1-0 for workspaces 1-10, F1-F10 for workspaces 11-20.
  - **Deliverables**:
    - Keybinding generation in generated script
  - **Requirements**: Keybinding Requirements (Section 4)
  - **Dependencies**: 2.1
  - **Details**:
    - `SUPER + 1-9, 0` → workspaces 1-10
    - `SUPER + F1-F10` → workspaces 11-20 (when `generateFKeys = true` and external monitor present)
    - `SUPER_SHIFT` variants for movetoworkspace

- [x] **2.4** Create `monitor_watcher` script template
  - **Description**: Generate the monitor_watcher script with Nix-interpolated primary monitor value instead of hardcoded "eDP-1".
  - **Deliverables**:
    - Add monitor_watcher generation in `modules/home/wm/hyprland/default.nix`
  - **Requirements**: Monitor Detection Requirements (Section 4)
  - **Dependencies**: 2.1
  - **Details**:
    - Use socat to listen to Hyprland IPC socket
    - Trigger regeneration on monitoradded/monitorremoved events
    - Pass correct primary monitor to generate_workspace_config

### Phase 3: File Management

- [x] **3.1** Configure selective file copying
  - **Description**: Modify the `home.file` configuration to copy static config files from `hypr_config/` while excluding the scripts that will be generated by Nix.
  - **Deliverables**:
    - Update file copying logic in `modules/home/wm/hyprland/default.nix`
  - **Requirements**: Technical Architecture (design.md)
  - **Dependencies**: 2.1, 2.4
  - **Details**:
    - Use `lib.cleanSourceWith` with filter to exclude:
      - `scripts/generate_workspace_config`
      - `scripts/monitor_watcher`
    - Or use explicit `home.file` entries for each static file

- [x] **3.2** Ensure runtime dependencies
  - **Description**: Add `jq` and `socat` to `home.packages` if not already present, as they are required by the generated scripts.
  - **Deliverables**:
    - Update `home.packages` in module
  - **Requirements**: Dependencies (design.md)
  - **Dependencies**: 1.1

### Phase 4: Testing & Validation

- [x] **4.1** Test default configuration (Emberroot)
  - **Description**: Build and test the configuration with default values to ensure backward compatibility with current Emberroot setup.
  - **Deliverables**:
    - Successful `sudo sys test` on Emberroot
    - Verify workspaces.conf is generated correctly
    - Verify keybindings work as expected
  - **Requirements**: Success Criteria (requirements.md Section 9)
  - **Dependencies**: 3.1, 3.2
  - **Validation**:
    - [x] Single monitor: workspaces 1-10 on primary
    - [x] Number keys 1-0 switch to workspaces 1-10
    - [x] No errors in Hyprland log

- [ ] **4.2** Test multi-monitor and hotplug
  - **Description**: Test with external monitor connected, and verify hotplug regeneration works correctly.
  - **Deliverables**:
    - Working dual-monitor workspace distribution
    - Working hotplug detection and regeneration
  - **Requirements**: Monitor Detection Requirements, Success Criteria
  - **Dependencies**: 4.1
  - **Validation**:
    - [ ] External monitor detected and assigned workspaces
    - [ ] F1-F10 keys work for workspaces 11-20
    - [ ] Unplugging monitor triggers regeneration
    - [ ] Workspaces migrate correctly

### Phase 5: Documentation & User Guide

- [x] **5.1** Create user guide for Nix configuration options
  - **Description**: Document all available Nix module options with examples for common setups.
  - **Deliverables**:
    - Documentation file: `modules/home/wm/hyprland/README.md`
  - **Requirements**: User Documentation (requirements.md)
  - **Dependencies**: 4.1
  - **Details**:
    - Document `monitors.primary`, `monitors.primaryResolution`, `monitors.externalResolution`
    - Document `monitors.externalPosition` (left/right/above/below)
    - Document `monitors.refreshRate` options
    - Document `workspaces.distribution` strategies (split vs primary-all)
    - Document `keybindings.generateFKeys` option
    - Provide example configurations for common setups:
      - Single monitor (laptop)
      - Dual monitor (laptop + external on right)
      - Dual monitor (desktop with external on left)

- [x] **5.2** Document runtime user configuration (monitor-vars.conf)
  - **Description**: Create guide for users who want to override settings at runtime without rebuilding.
  - **Deliverables**:
    - Section in README.md for runtime configuration
  - **Requirements**: User Documentation
  - **Dependencies**: 5.1
  - **Details**:
    - Explain the priority system: user config > Nix config > auto-detect
    - Document all `VAR_*` variables:
      - `VAR_PRIMARY_MONITOR` - Primary monitor name
      - `VAR_PRIMARY_RESOLUTION` - Primary resolution (WIDTHxHEIGHT)
      - `VAR_EXTERNAL_RESOLUTION` - External monitor resolution
      - `VAR_EXTERNAL_POSITION` - Position: left, right, above, below
      - `VAR_REFRESH_RATE` - Refresh rate mode
      - `VAR_DISTRIBUTION` - Workspace distribution strategy
      - `VAR_GENERATE_FKEYS` - Enable/disable F-key bindings
    - Provide example monitor-vars.conf templates
    - Explain when to use runtime config vs Nix config

- [x] **5.3** Document troubleshooting and debugging
  - **Description**: Create troubleshooting guide with common issues and solutions.
  - **Deliverables**:
    - Troubleshooting section in README.md
  - **Requirements**: User Documentation
  - **Dependencies**: 5.1, 5.2
  - **Details**:
    - How to check workspace-gen.log for issues
    - How to manually regenerate workspaces.conf
    - How to verify monitor detection (`hyprctl monitors`)
    - Common issues:
      - Monitor not detected
      - Workspaces not switching correctly
      - F-keys not working
      - Hotplug not triggering regeneration
    - How to reset to defaults

## Task Completion Criteria

Each task is considered complete when:
- [ ] All deliverables are implemented and functional
- [ ] Code follows Nix/NixOS coding standards
- [ ] Configuration builds without errors (`nix flake check`)
- [ ] Module integrates properly with existing Snowfall structure

## Progress Tracking

### Milestone Checkpoints
- **Milestone 1**: Phase 1 Complete - Module options defined
- **Milestone 2**: Phase 2 Complete - Scripts generate correctly
- **Milestone 3**: Phase 3 Complete - Full module integration
- **Milestone 4**: Phase 4 Complete - Tested and validated
- **Milestone 5**: Phase 5 Complete - Documentation ready

### Definition of Done
A task is considered "Done" when:
1. **Functionality**: All specified functionality is implemented
2. **Build**: `sudo sys test` succeeds
3. **Integration**: Module works with existing Hyprland configuration
4. **Requirements**: All linked requirements are satisfied

## Risk Mitigation

### Technical Risks
- **Risk**: Script string interpolation in Nix can be error-prone with escaping
  - **Mitigation**: Use `''` for multi-line strings, escape `$` as `''$` where needed
  - **Affected Tasks**: 2.1, 2.2, 2.3, 2.4

- **Risk**: Monitor names vary by hardware/driver
  - **Mitigation**: Auto-detection fallback when `primary = null`, logging for debugging
  - **Affected Tasks**: 2.1, 4.1, 4.2

### Dependency Risks
- **Risk**: Missing `jq` or `socat` at runtime
  - **Mitigation**: Explicitly add to `home.packages` in task 3.2
  - **Affected Tasks**: 3.2, 4.1

## Known Issues

### Issue #1: monitor-vars.conf not affecting workspace generation
- **Status**: Resolved ✓
- **Description**: The user config file (`~/.config/hypr/monitor-vars.conf`) was not being fully applied during workspace generation.
- **Root Cause**: The script only checked for `VAR_PRIMARY_MONITOR`, `VAR_PRIMARY_RESOLUTION`, and `VAR_EXTERNAL_RESOLUTION` but did not apply overrides for `VAR_EXTERNAL_POSITION`, `VAR_REFRESH_RATE`, `VAR_DISTRIBUTION`, and `VAR_GENERATE_FKEYS`.
- **Resolution**: Added override logic for all VAR_ variables after sourcing the user config file.
- **Fixed in**: 2026-01-14

## Git Tracking

**Branch**: `feature/202601` (current branch)

**Related Commits**:
- `b0de6c6` - feat(hyprland): Add dynamic workspace configuration system

---

**Task Status**: In Progress

**Current Phase**: Phase 4 (Testing & Validation) - Task 4.2 pending

**Overall Progress**: 12/13 tasks completed (92%)

**Last Updated**: 2026-01-14
